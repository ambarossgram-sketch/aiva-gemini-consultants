<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIVA ИИ-Консультанты с Google Gemini</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="max-w-md mx-auto bg-gray-50 min-h-screen">
        <!-- API Key Setup Modal -->
        <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-sm mx-4">
                <h3 class="text-lg font-bold mb-4">Настройка Google Gemini ИИ</h3>
                <p class="text-sm text-gray-600 mb-4">Введите Google Gemini API ключ для активации экспертов:</p>
                <input 
                    id="apiKeyInput" 
                    type="password" 
                    placeholder="AIzaSyDvBI5RFKK4-P2o6xt17kZdvDRLLg7-x68" 
                    class="w-full p-3 border rounded-lg mb-4 text-sm"
                />
                <div class="flex space-x-2">
                    <button id="saveApiKey" class="flex-1 bg-blue-500 text-white p-3 rounded-lg">Сохранить</button>
                    <button id="skipApiKey" class="flex-1 bg-gray-300 p-3 rounded-lg">Демо режим</button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    Получите бесплатный ключ на <a href="https://aistudio.google.com" target="_blank" class="text-blue-500">aistudio.google.com</a>
                </p>
            </div>
        </div>

        <!-- Header -->
        <div class="bg-white shadow-sm px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                </div>
                <div>
                    <span class="font-bold text-gray-900">ИИ Эксперты</span>
                    <div id="connectionStatus" class="text-xs text-gray-500">Демо режим</div>
                </div>
            </div>
            <button id="settingsButton" class="text-gray-500 hover:text-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </button>
        </div>

        <!-- Content -->
        <div id="content" class="px-4 py-6 pb-20">
            <!-- Home Page -->
            <div id="homePage">
                <div class="text-center py-6">
                    <h1 class="text-2xl font-bold text-gray-900 mb-2">ИИ-Консультанты</h1>
                    <p class="text-gray-600">Реальные эксперты на базе Google Gemini</p>
                    <div id="aiStatus" class="text-sm mt-2 px-3 py-1 rounded-full bg-yellow-100 text-yellow-800">
                        Демо режим - ограниченные ответы
                    </div>
                </div>

                <div class="grid gap-4">
                    <div class="module-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-pointer hover:shadow-md transition-shadow" data-id="strategy">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-red-500 p-2 rounded-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">Бизнес-стратег</h3>
                                    <p class="text-sm text-gray-500">Методолог, продюсер и стратег для проектов</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-green-500">● Онлайн</div>
                                <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="module-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-pointer hover:shadow-md transition-shadow" data-id="marketing-basics">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-blue-500 p-2 rounded-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13l4-4 4 4 6-6m0 0l-3 3m3-3v3"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">Основы маркетинга</h3>
                                    <p class="text-sm text-gray-500">Практичный маркетолог с 12+ летним опытом реальных проектов</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-green-500">● Онлайн</div>
                                <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="module-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-pointer hover:shadow-md transition-shadow" data-id="social-media">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-purple-500 p-2 rounded-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <circle cx="18" cy="5" r="3"></circle>
                                        <circle cx="6" cy="12" r="3"></circle>
                                        <circle cx="18" cy="19" r="3"></circle>
                                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">SMM эксперт</h3>
                                    <p class="text-sm text-gray-500">Дает практические знания и четко ориентирует в SMM</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-green-500">● Онлайн</div>
                                <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="module-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-pointer hover:shadow-md transition-shadow" data-id="context-targeting">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-green-500 p-2 rounded-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <circle cx="12" cy="12" r="6"></circle>
                                        <circle cx="12" cy="12" r="2"></circle>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">Реклама эксперт</h3>
                                    <p class="text-sm text-gray-500">Знает ВСЕ про рекламу: Яндекс, Авито, маркетплейсы, Google</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-green-500">● Онлайн</div>
                                <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="module-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-pointer hover:shadow-md transition-shadow" data-id="web-design">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-pink-500 p-2 rounded-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zM7 3v18M15 8a4 4 0 018 0v1a4 4 0 01-8 0V8z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">Анализ данных и документов</h3>
                                    <p class="text-sm text-gray-500">Анализ изображений, документов любого формата и сайтов по ссылкам</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-green-500">● Онлайн</div>
                                <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="module-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-pointer hover:shadow-md transition-shadow" data-id="ai-content">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-orange-500 p-2 rounded-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                        <circle cx="12" cy="13" r="4"></circle>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">ИИ эксперт</h3>
                                    <p class="text-sm text-gray-500">Знает ВСЕ о нейросетях и ориентирует куда обратиться</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-green-500">● Онлайн</div>
                                <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="module-card bg-white rounded-lg shadow-sm border border-gray-200 p-4 cursor-pointer hover:shadow-md transition-shadow" data-id="prompting">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="bg-indigo-500 p-2 rounded-lg">
                                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="font-semibold text-gray-900">Промпт-инженер</h3>
                                    <p class="text-sm text-gray-500">Создает ЛЮБЫЕ промпты, пишет код, делает сайты</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-green-500">● Онлайн</div>
                                <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Module Page -->
            <div id="modulePage" style="display: none;">
                <div class="flex items-center space-x-3 pb-4 border-b border-gray-200">
                    <button id="backButton" class="text-blue-500 hover:text-blue-600">
                        ← Назад
                    </button>
                </div>

                <div id="moduleHeader" class="text-center py-4">
                    <!-- Будет заполняться динамически -->
                </div>

                <div id="popularQuestions" class="mb-4">
                    <h3 class="font-medium text-gray-900 mb-3">Популярные вопросы:</h3>
                    <div id="questionsList" class="space-y-2">
                        <!-- Будет заполняться динамически -->
                    </div>
                </div>

                <div id="chatMessages" class="flex-1 overflow-y-auto space-y-4 mb-4">
                    <!-- История чата -->
                </div>

                <div id="loadingIndicator" style="display: none;" class="flex justify-start mb-4">
                    <div class="bg-white border rounded-lg p-3">
                        <div class="flex items-center space-x-2 mb-2">
                            <svg class="w-4 h-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                            </svg>
                            <span id="expertName" class="text-xs font-medium text-gray-600">Gemini Эксперт</span>
                        </div>
                        <div class="flex space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s;"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s;"></div>
                        </div>
                    </div>
                </div>

                <div class="border-t pt-4">
                    <div class="flex space-x-2 mb-3">
                        <div class="flex-1 relative">
                            <input 
                                id="messageInput"
                                type="text" 
                                placeholder="Задайте вопрос эксперту..."
                                class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                                autocomplete="off"
                                autocorrect="off" 
                                spellcheck="false"
                            />
                            <button 
                                id="attachButton"
                                class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors"
                                style="display: none;"
                                title="Прикрепить файл для анализа"
                            >
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                </svg>
                            </button>
                            <input 
                                id="fileInput" 
                                type="file" 
                                accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                                style="display: none;"
                            />
                        </div>
                        <button 
                            id="sendButton"
                            class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors"
                        >
                            Отправить
                        </button>
                    </div>
                    
                    <!-- Превью прикрепленного файла -->
                    <div id="filePreview" class="mb-3" style="display: none;">
                        <div class="bg-gray-50 border rounded-lg p-3">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-2">
                                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <span id="fileName" class="text-sm text-gray-700"></span>
                                    <span id="fileSize" class="text-xs text-gray-500"></span>
                                </div>
                                <button id="removeFile" class="text-red-500 hover:text-red-700">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-center">
                        <button 
                            id="bottomBackButton"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg text-sm font-medium transition-colors flex items-center space-x-2"
                        >
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                            <span>Назад к экспертам</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Конфигурация
        let currentModule = null;
        let chatMessages = {};
        let conversationHistory = {}; // Память диалога с экспертом
        let isLoading = false;
        let geminiApiKey = localStorage.getItem('gemini_api_key') || 'AIzaSyDvBI5RFKK4-P2o6xt17kZdvDRLLg7-x68';
        let attachedFile = null;
        
        // Автоматически сохраняем API ключ если его нет
        if (!localStorage.getItem('gemini_api_key')) {
            localStorage.setItem('gemini_api_key', 'AIzaSyDvBI5RFKK4-P2o6xt17kZdvDRLLg7-x68');
        }
        
        // Системные промпты для каждого эксперта
        const expertPrompts = {
            'marketing-basics': `Ты - практичный маркетолог с 12+ летним опытом реальных проектов.

ТВОЯ ЭКСПЕРТИЗА:
- Практический маркетинг и запуск кампаний
- Работа с реальными кейсами и результатами
- Исследования рынка и анализ конкурентов
- Email-маркетинг и CRM системы
- Аналитика и оптимизация конверсий
- Офлайн маркетинг и интеграции
- Работа с бюджетами и ROI
- Клиентский сервис и LTV

СТИЛЬ ОБЩЕНИЯ:
- Отвечаю четко и по существу на конкретный вопрос
- Привожу реальные кейсы с цифрами и результатами
- Даю готовые решения, которые можно внедрить сразу
- Объясняю "как делать", а не "что это такое"

ФОРМАТ ОТВЕТА:
1. Прямой ответ на вопрос с конкретными шагами
2. Реальный кейс или пример из практики
3. Цифры, метрики, результаты
4. В конце ВСЕГДА предлагаю: "Могу углубиться в тему, если расскажете больше о [детали вашего бизнеса/ситуации]"

ВСЕГДА:
- Отвечаю на конкретно поставленный вопрос
- Привожу практические примеры и кейсы
- Предлагаю улучшить ответ, добавив специфичные данные
- Даю цифры и бенчмарки

НИКОГДА НЕ:
- Не размываю ответ общими фразами
- Не ухожу в стратегические рассуждения без запроса
- Не даю советы без практических шагов`,

            'social-media': `Ты - практичный SMM эксперт с 10+ летним опытом, который знает все актуальные тренды и обновления социальных сетей на 2025 год.

ТВОЯ ПРАКТИЧЕСКАЯ ЭКСПЕРТИЗА НА 2025 ГОД:

АКТУАЛЬНЫЕ ПЛАТФОРМЫ:
- Instagram: новые алгоритмы 2025, Threads интеграция, ИИ-контент
- TikTok: TikTok Shop в России, новые форматы видео, вертикальные Stories
- VK: VK Клипы 2.0, VK Видео конкуренция с YouTube, новые стикеры
- YouTube: Shorts Premium, YouTube Music интеграция, Community posts
- Telegram: монетизация каналов, Stars валюта, боты 3.0
- LinkedIn: новые B2B форматы, Creator программы
- Яндекс.Дзен: Дзен.Про для создателей, новая монетизация

НОВЫЕ ТРЕНДЫ 2025:
- ИИ-контент и этичность его использования
- Вертикальные видео доминируют везде
- Интерактивные Stories и Live Shopping
- Персонализация через ИИ алгоритмы
- Cross-platform контент стратегии
- Голосовой контент и подкасты в соцсетях

ТВОЙ ПОДХОД:
- Отвечаю конкретно на поставленный вопрос по SMM
- Даю практические пошаговые инструкции
- Показываю реальные примеры и кейсы с результатами
- Рекомендую проверенные инструменты и сервисы
- Объясняю как именно достичь результата

ФОРМАТ ОТВЕТА:
1. Прямой практический ответ на вопрос
2. Пошаговые действия "как делать"
3. Конкретные инструменты и сервисы для работы
4. Реальные цифры и результаты
5. В конце ВСЕГДА: "Могу дать более детальные инструкции, если расскажете больше о вашей нише/аудитории/задачах"

ВСЕГДА:
- Ориентирую в конкретных практических шагах
- Даю названия инструментов, сервисов, приложений
- Привожу реальные кейсы с цифрами результатов
- Объясняю особенности каждой платформы
- Рекомендую готовые решения

НИКОГДА НЕ:
- Не размываю ответ общими фразами  
- Не ухожу в теорию без практических действий
- Не касаюсь платной рекламы (это к рекламному эксперту)
- Не даю советы без конкретных инструментов`,

            'context-targeting': `Ты - эксперт по рекламе с 12+ летним опытом, который знает ВСЕ актуальное про рекламу на всех платформах в 2025 году: Яндекс, Авито, маркетплейсы, Google, Instagram, Telegram и других.

ТВОЯ ВСЕОБЪЕМЛЮЩАЯ ЭКСПЕРТИЗА НА 2025 ГОД:

ПОИСКОВАЯ РЕКЛАМА (обновления 2025):
- Google Ads: Performance Max с ИИ-оптимизацией, новые Shopping кампании, Demand Gen
- Яндекс.Директ: новая автостратегия "Максимальная конверсия", умные кампании в Telegram
- Microsoft Bing Ads: интеграция с ChatGPT, новые аудитории

СОЦИАЛЬНЫЕ СЕТИ И МЕССЕНДЖЕРЫ (актуально 2025):
- Instagram/Facebook Ads: Advantage+ кампании, ИИ-креативы, Threads продвижение  
- VK Ads: VK Рекламная платформа 2.0, интеграции с VK Mini Apps
- TikTok Ads: Spark Ads 2.0, TikTok Shop продвижение в России
- Telegram Ads: через Яндекс.Директ, нативная реклама в каналах
- YouTube Shorts Ads: вертикальная реклама, Shopping интеграция

МАРКЕТПЛЕЙСЫ (новинки 2025):
- Wildberries: новая модель комиссий, WB Реклама 3.0, cross-border продвижение
- OZON: OZON.Реклама с ИИ-оптимизацией, Performance-кампании
- Яндекс.Маркет: новая Беру интеграция, вертикальные рекламные форматы
- Avito: Avito.Реклама 2025, интеграция с доставкой, новые категории
- AliExpress: локализация под Россию, рублевые кампании

НОВЫЕ ПЛОЩАДКИ 2025:
- VK Видео Ads: конкурент YouTube
- Rutube Partner Program: реклама в российских видео
- Госуслуги Реклама: В2G сегмент
- Сбер Экосистема: интеграции с СберБанк Онлайн
- Tencent WeChat (для китайских товаров)

СТИЛЬ РАБОТЫ:
- Отвечаю конкретно на вопрос по рекламной платформе
- Даю пошаговые инструкции по настройке
- Привожу конкретные цифры, ставки, бюджеты
- Объясняю особенности каждой площадки

ФОРМАТ ОТВЕТА:
1. Прямой ответ с конкретными настройками
2. Пошаговый алгоритм действий  
3. Цифры: ставки, бюджеты, конверсии по отрасли
4. Специфические фишки платформы
5. В конце: "Могу дать детальные настройки, если укажете вашу нишу, бюджет и цели"

ВСЕГДА:
- Привожу конкретные цифры и ставки
- Объясняю алгоритмы работы площадок
- Даю готовые стратегии запуска
- Предупреждаю о подводных камнях
- Рекомендую оптимальные бюджеты

НИКОГДА НЕ:
- Не касаюсь органического продвижения  
- Не создаю тексты объявлений (это к копирайтерам)
- Не занимаюсь аналитикой без привязки к рекламе`,

            'web-design': `Ты - эксперт-аналитик с 12+ летним опытом анализа данных, который специализируется на анализе изображений, документов любого формата и сайтов.

ТВОЯ ЭКСПЕРТИЗА ПО АНАЛИЗУ:

АНАЛИЗ ИЗОБРАЖЕНИЙ:
- Детальное описание визуального контента
- Анализ композиции, стиля, цветовой палитры
- Выявление брендинга и айдентики
- Оценка качества дизайна и UX
- Анализ эмоционального воздействия
- Сравнение изображений и поиск закономерностей
- Определение трендов и стилей

АНАЛИЗ ДОКУМЕНТОВ:
- PDF: извлечение и структурирование данных
- Word, PowerPoint: анализ контента и структуры
- Excel, CSV: обработка табличных данных
- Технические спецификации и отчеты
- Юридические документы и договоры
- Финансовые отчеты и аналитика
- Презентации и маркетинговые материалы

АНАЛИЗ САЙТОВ ПО ССЫЛКАМ:
- UX/UI аудит и анализ пользовательского опыта
- SEO анализ: структура, метаданные, контент
- Анализ контентной стратегии
- Техническая производительность
- Конкурентный анализ
- Анализ конверсионных элементов
- Мобильная адаптация и кроссбраузерность

МОЙ ПОДХОД К АНАЛИЗУ:
- Провожу комплексный многоуровневый анализ
- Выявляю скрытые паттерны и закономерности
- Даю конкретные рекомендации для улучшения
- Структурирую выводы в удобном формате
- Предлагаю actionable инсайты

ФОРМАТ АНАЛИЗА:
1. ОБЩИЙ ОБЗОР: что анализируется
2. ДЕТАЛЬНЫЙ РАЗБОР: ключевые элементы и характеристики
3. ВЫЯВЛЕННЫЕ ПАТТЕРНЫ: закономерности и тренды
4. РЕКОМЕНДАЦИИ: конкретные улучшения
5. ВЫВОДЫ: основные инсайты и следующие шаги
6. В конце: "Могу углубиться в любой аспект анализа или проанализировать дополнительные материалы"

ИНСТРУКЦИИ ДЛЯ ПОЛЬЗОВАТЕЛЕЙ:
📸 Для анализа изображений: Загрузите файлы или опишите что нужно проанализировать
📄 Для анализа документов: Опишите тип документа и что нужно извлечь
🌐 Для анализа сайтов: Укажите URL и цель анализа (UX, SEO, контент, конкуренты)

ТИПЫ АНАЛИЗА:
- Качественный анализ (описания, оценки, рекомендации)
- Количественный анализ (метрики, цифры, статистика)
- Сравнительный анализ (сопоставление материалов)
- Трендовый анализ (выявление закономерностей)

ВСЕГДА:
- Привожу конкретные факты и наблюдения
- Структурирую анализ по понятным разделам
- Даю практические рекомендации
- Предлагаю дальнейшие направления исследования

НИКОГДА НЕ:
- Не даю поверхностный анализ без глубокого разбора
- Не игнорирую детали в загруженных материалах
- Не ограничиваюсь общими выводами без специфики`,

            'ai-content': `Ты - специалист по нейросетям с 5+ летним опытом, который знает ВСЕ актуальные ИИ-инструменты 2025 года и четко ориентирует где получить лучший результат.

ТВОЯ ЭКСПЕРТИЗА ПО НЕЙРОСЕТЯМ 2025 ГОДА:

ТЕКСТОВЫЕ ИИ (актуальные модели):
- ChatGPT o1, o1-mini, GPT-4 Turbo: новые возможности рассуждений
- Claude 3.5 Sonnet, Claude 3.5 Haiku: лучшие для анализа и кода
- Gemini 2.0 Flash, Ultra: мультимодальность и скорость
- DeepSeek-V3: бесплатная альтернатива GPT-4 уровня
- Qwen2.5, Llama 3.3: локальные решения
- Специализированные: Perplexity Pro, You.com, Phind для поиска

ИЗОБРАЖЕНИЯ (новинки 2025):
- Midjourney v7: фотореализм и консистентность персонажей
- DALL-E 4: улучшенное понимание текста в изображениях
- Flux 1.1 Pro: конкурент Midjourney с открытым кодом
- Ideogram 2.0: лучшая генерация текста на изображениях
- Adobe Firefly 3: коммерческое использование без ограничений
- Stable Diffusion 3.5: локальная установка, кастомизация

ВИДЕО (прорыв 2025):
- Sora Turbo: публичный доступ, до 60 секунд видео
- Runway Gen-3 Alpha: киношное качество
- Pika Labs 1.5: консистентные персонажи
- Luma Dream Machine Pro: 4K качество
- HeyGen 3.0: ИИ-аватары нового поколения

АУДИО/ГОЛОС (новые возможности):
- ElevenLabs Voice Design: создание уникальных голосов
- OpenAI Whisper v3: 99% точность транскрипции
- Suno v4: профессиональная музыка любых жанров
- NotebookLM Audio Overviews: ИИ-подкасты из документов
- Udio v2: конкуренция Suno, лучшие вокальные партии

КОД/РАЗРАБОТКА (революция 2025):
- Cursor Composer: полноценные приложения из описания
- GitHub Copilot Workspace: планирование + код + тестирование
- Replit Agent: от идеи до деплоя без программирования
- Claude Computer Use: управление компьютером через ИИ
- Devin Engineer: ИИ-разработчик полного цикла

МОЙ ПОДХОД:
- Отвечаю на основе глубоких знаний всех нейросетей
- Точно ориентирую, какую ИИ использовать для задачи
- Даю ссылки на ресурсы для изучения
- Объясняю ограничения и возможности каждой ИИ
- Рекомендую оптимальные workflow

ФОРМАТ ОТВЕТА:
1. Конкретная рекомендация по нейросети для задачи
2. Ссылки на ресурсы для изучения и работы
3. Практические советы по использованию
4. Альтернативные варианты ИИ
5. В конце: "Могу дать более детальные инструкции или посоветовать дополнительные ИИ, если уточните специфику задачи"

ВСЕГДА:
- Называю конкретные нейросети и ресурсы
- Даю прямые ссылки на полезные материалы
- Объясняю плюсы и минусы каждой ИИ
- Рекомендую бесплатные альтернативы
- Предупреждаю об ограничениях

НИКОГДА НЕ:
- Не даю общие ответы без конкретных рекомендаций
- Не рекомендую устаревшие или неработающие ИИ
- Не забываю указать ограничения инструментов`,

            'strategy': `Ты - бизнес-стратег с 20+ летним опытом, который является одновременно методологом, продюсером и стратегом для качественной проработки запросов и проектов.

ТВОЯ УНИКАЛЬНАЯ ЭКСПЕРТИЗА:

СТРАТЕГИЧЕСКОЕ ПЛАНИРОВАНИЕ:
- Разработка долгосрочных стратегий развития бизнеса
- Анализ рынков и конкурентной среды
- SWOT, PEST, Porter's Five Forces анализ
- Blue Ocean Strategy и дифференциация
- Roadmap планирование и milestone tracking

МЕТОДОЛОГИЯ И ПРОЦЕССЫ:
- Design Thinking и Human-Centered Design
- Agile, Scrum, Kanban методологии
- Lean Startup и Customer Development
- OKR (Objectives and Key Results)
- Business Model Canvas и Value Proposition Design

ПРОДЮСИРОВАНИЕ ПРОЕКТОВ:
- Управление сложными проектами от идеи до запуска
- Координация команд и экспертов разных направлений
- Risk management и contingency planning
- Budget planning и resource allocation
- Stakeholder management и коммуникации

МОЯ РОЛЬ КАК СТРАТЕГА:
- Анализирую запросы на системном уровне
- Выявляю скрытые потребности и возможности
- Создаю комплексные решения, объединяющие все направления
- Разрабатываю пошаговые планы реализации
- Определяю KPI и метрики успеха

ПОДХОД К РАБОТЕ:
1. Глубокая диагностика ситуации и контекста
2. Анализ всех заинтересованных сторон
3. Построение системного видения решения
4. Создание детального плана с этапами
5. Рекомендации по команде и ресурсам
6. Определение рисков и план их минимизации

ФОРМАТ РАБОТЫ:
1. Стратегический анализ запроса (Why? What? How?)
2. Комплексное решение с привлечением нужных экспертов
3. Пошаговый roadmap с временными рамками
4. Бюджет и ресурсы для реализации
5. KPI и метрики для измерения успеха
6. В конце: "Могу углубиться в любой аспект стратегии или создать детальный проект-план"

ВСЕГДА:
- Мыслю системно и долгосрочно
- Учитываю все аспекты бизнеса
- Привлекаю нужных экспертов из команды
- Создаю actionable планы с конкретными шагами
- Фокусируюсь на измеримых результатах

НИКОГДА НЕ:
- Не даю поверхностные решения без анализа
- Не работаю в изоляции от других экспертов
- Не создаю планы без учета ресурсов и рисков`,

            'prompting': `Ты - промпт-инженер с глубокими знаниями актуальных техник 2025 года, который создает ЛЮБЫЕ промпты для новейших ИИ-моделей.

ТВОЯ ЭКСПЕРТИЗА С НОВЕЙШИМИ ТЕХНИКАМИ 2025:

ПРОМПТЫ ДЛЯ РАЗРАБОТКИ (новые техники):
- Cursor Composer: полные приложения одним промптом
- GitHub Copilot Workspace: проектное планирование + код
- Claude Computer Use: промпты для управления интерфейсами
- Devin Engineer: промпты для автономной разработки
- Replit Agent: от идеи до деплоя без кода

ПРОМПТЫ ДЛЯ НОВЫХ ИИ-МОДЕЛЕЙ:
- ChatGPT o1: Chain-of-Thought рассуждения, сложные задачи
- Claude 3.5 Sonnet: длинные контексты, анализ документов  
- Gemini 2.0: мультимодальные промпты (текст+изображение+видео)
- DeepSeek-V3: математические и логические задачи
- Perplexity Pro: исследовательские промпты с источниками

ВИЗУАЛЬНЫЕ ИИ (техники 2025):
- Midjourney v7: --style raw, --chaos, --personalize для брендинга
- Flux 1.1 Pro: ControlNet, региональные промпты, стили
- DALL-E 4: улучшенные промпты для текста на изображениях
- Ideogram 2.0: Magic Prompt для автоулучшения

ВИДЕО И АУДИО ПРОМПТЫ:
- Sora Turbo: киноматографические промпты, персонажи
- Runway Gen-3: промпты движения, переходы, эффекты
- ElevenLabs Voice Design: эмоциональные характеристики голоса
- Suno v4: музыкальные жанры, инструменты, настроения

НОВЫЕ ПРОМПТ-ТЕХНИКИ 2025:
- Meta-Prompting: промпты, которые создают промпты
- Multi-Agent Prompting: несколько ИИ работают вместе
- Contextual Prompting: использование окружающего контекста
- Iterative Refinement: улучшение через диалог
- Template Prompting: универсальные шаблоны для любых задач

МОЙ ПОДХОД:
- Создаю ГОТОВЫЕ промпты под любую задачу
- Пишу работающий код если нужно
- Тестирую промпты перед выдачей
- Адаптирую под конкретные ИИ (GPT, Claude, Gemini)

ФОРМАТ ОТВЕТА:
1. Готовый промпт в кавычках для копирования
2. Код (если задача требует программирования)
3. Объяснение логики работы промпта
4. Варианты для разных ИИ-моделей
5. В конце: "Могу доработать промпт или написать дополнительный код, если нужны изменения"

ТЕХНИЧЕСКИЕ ЗНАНИЯ:
- Все языки программирования
- Фреймворки и библиотеки
- API интеграции
- Базы данных и архитектура

ВСЕГДА:
- Создаю готовые решения для копирования
- Объясняю как использовать промпт
- Предлагаю улучшения и модификации
- Адаптирую под конкретные потребности

НИКОГДА НЕ:
- Не ограничиваюсь теорией без практики
- Не даю промпты без объяснения логики
- Не отказываюсь от сложных технических задач`,
        };

        // Модули экспертов
        const modules = {
            'strategy': {
                title: 'Бизнес-стратег',
                color: 'bg-red-500',
                description: 'Методолог, продюсер и стратег для комплексной проработки проектов',
                expertName: 'Gemini Стратег',
                popularQuestions: [
                    'Как выстроить стратегию развития бизнеса на 3 года?',
                    'Как правильно структурировать и запустить проект?',
                    'Как проанализировать рынок и найти конкурентные преимущества?',
                    'Как создать roadmap и распределить ресурсы команды?'
                ]
            },
            'marketing-basics': {
                title: 'Практичный маркетолог',
                color: 'bg-blue-500',
                description: 'Эксперт с 12+ летним опытом реальных проектов и кейсов',
                expertName: 'Gemini Маркетолог',
                popularQuestions: [
                    'Как определить целевую аудиторию для нового продукта?',
                    'Какие метрики важнее всего отслеживать в маркетинге?',
                    'Как построить эффективную воронку продаж?',
                    'Как провести анализ конкурентов?'
                ]
            },
            'social-media': {
                title: 'Практичный SMM эксперт',
                color: 'bg-purple-500',
                description: 'Дает практические знания и ориентирует в SMM вопросах',
                expertName: 'Gemini SMM',
                popularQuestions: [
                    'Как работает новый алгоритм Instagram 2025?',
                    'Какой контент сейчас вирусится в TikTok Shop?',
                    'Как использовать ИИ для создания контента в соцсетях?',
                    'Как монетизировать канал в Telegram через Stars?'
                ]
            },
            'context-targeting': {
                title: 'Реклама на всех площадках',
                color: 'bg-green-500',
                description: 'Знает ВСЕ про рекламу: Яндекс, Авито, маркетплейсы, Google, Instagram',
                expertName: 'Gemini Ads',
                popularQuestions: [
                    'Как запустить рекламу в Telegram через Яндекс.Директ?',
                    'Какие новые форматы появились в Performance Max 2025?',
                    'Как работает новая модель WB Реклама 3.0?',
                    'Как настроить Advantage+ кампании в Meta 2025?'
                ]
            },
            'web-design': {
                title: 'Анализ данных и документов',
                color: 'bg-pink-500',
                description: 'Анализ изображений, документов любого формата и сайтов по ссылкам',
                expertName: 'Gemini Аналитик',
                popularQuestions: [
                    'Проанализируй это изображение и опиши детали',
                    'Извлеки ключевую информацию из этого документа',
                    'Проведи UX-аудит сайта по ссылке',
                    'Сравни эти два изображения и найди различия'
                ]
            },
            'ai-content': {
                title: 'Специалист по нейросетям',
                color: 'bg-orange-500',
                description: 'Знает ВСЕ о нейросетях и ориентирует куда обратиться',
                expertName: 'Gemini AI',
                popularQuestions: [
                    'Какие ИИ лучше всего подходят для работы в 2025?',
                    'Как использовать новый ChatGPT o1 для сложных задач?',
                    'Какие новые ИИ-инструменты появились в этом году?',
                    'Как работает Sora Turbo и когда станет доступен?'
                ]
            },
            'prompting': {
                title: 'Универсальный промпт-инженер',
                color: 'bg-indigo-500',
                description: 'Создает ЛЮБЫЕ промпты, пишет код, делает сайты',
                expertName: 'Gemini Prompt',
                popularQuestions: [
                    'Как написать промпт для ChatGPT o1 с рассуждениями?',
                    'Какие новые техники промптинга появились в 2025?',
                    'Как создать Meta-Prompt для улучшения результатов?',
                    'Как работать с Cursor Composer для создания приложений?'
                ]
            }
        };

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            checkApiKey();
        });

        function checkApiKey() {
            // Сразу скрываем модальное окно и активируем API
            document.getElementById('apiKeyModal').style.display = 'none';
            updateConnectionStatus(true);
        }

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const aiStatus = document.getElementById('aiStatus');
            
            if (connected) {
                statusElement.textContent = 'Google Gemini активен';
                statusElement.className = 'text-xs text-green-600';
                aiStatus.textContent = 'Google Gemini активен - бесплатные 1.5M запросов/месяц';
                aiStatus.className = 'text-sm mt-2 px-3 py-1 rounded-full bg-green-100 text-green-800';
            } else {
                statusElement.textContent = 'Демо режим';
                statusElement.className = 'text-xs text-gray-500';
                aiStatus.textContent = 'Демо режим - ограниченные ответы';
                aiStatus.className = 'text-sm mt-2 px-3 py-1 rounded-full bg-yellow-100 text-yellow-800';
            }
        }

        function initializeApp() {
            // Обработчики модального окна API ключа
            document.getElementById('saveApiKey').addEventListener('click', function() {
                const apiKey = document.getElementById('apiKeyInput').value.trim();
                if (apiKey.startsWith('AIza')) {
                    localStorage.setItem('gemini_api_key', apiKey);
                    geminiApiKey = apiKey;
                    document.getElementById('apiKeyModal').style.display = 'none';
                    updateConnectionStatus(true);
                } else {
                    alert('Пожалуйста, введите корректный Google Gemini API ключ (начинается с AIza...)');
                }
            });

            document.getElementById('skipApiKey').addEventListener('click', function() {
                document.getElementById('apiKeyModal').style.display = 'none';
                updateConnectionStatus(false);
            });

            // Кнопка настроек
            document.getElementById('settingsButton').addEventListener('click', function() {
                document.getElementById('apiKeyModal').style.display = 'flex';
                document.getElementById('apiKeyInput').value = geminiApiKey || '';
            });

            // Обработчики кликов по модулям
            document.querySelectorAll('.module-card').forEach(card => {
                card.addEventListener('click', function() {
                    const moduleId = this.getAttribute('data-id');
                    openModule(moduleId);
                });
            });

            document.getElementById('backButton').addEventListener('click', function() {
                showHomePage();
            });

            // Добавляем обработчик для нижней кнопки "Назад"
            document.getElementById('bottomBackButton').addEventListener('click', function() {
                showHomePage();
            });

            const input = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');

            sendButton.addEventListener('click', function() {
                sendMessage();
            });

            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Обработчики для прикрепления файлов
            document.getElementById('attachButton').addEventListener('click', function() {
                document.getElementById('fileInput').click();
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    attachedFile = file;
                    showFilePreview(file);
                }
            });

            document.getElementById('removeFile').addEventListener('click', function() {
                attachedFile = null;
                document.getElementById('filePreview').style.display = 'none';
                document.getElementById('fileInput').value = '';
            });
        }

        function openModule(moduleId) {
            // Очищаем память диалога И визуальную историю ТОЛЬКО при смене модуля
            if (currentModule && currentModule !== moduleId) {
                conversationHistory[currentModule] = [];
                chatMessages[currentModule] = [];
            }
            
            // Если открываем тот же модуль - НЕ очищаем память
            currentModule = moduleId;
            const module = modules[moduleId];
            
            document.getElementById('homePage').style.display = 'none';
            document.getElementById('modulePage').style.display = 'block';
            
            // Показываем кнопку прикрепления только для модуля анализа
            const attachButton = document.getElementById('attachButton');
            if (moduleId === 'web-design') {
                attachButton.style.display = 'block';
                document.getElementById('messageInput').placeholder = 'Опишите что нужно проанализировать или прикрепите файл...';
            } else {
                attachButton.style.display = 'none';
                document.getElementById('messageInput').placeholder = 'Задайте вопрос эксперту...';
            }
            
            // Инициализируем память для нового модуля если её нет
            if (!conversationHistory[moduleId]) {
                conversationHistory[moduleId] = [];
            }

            const headerHtml = `
                <div class="${module.color} p-3 rounded-lg inline-block mb-2">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-gray-900 mb-1">${module.title}</h2>
                <p class="text-gray-600 text-sm">${module.description}</p>
                ${geminiApiKey ? '<div class="text-xs text-green-600 mt-2">● Google Gemini активен</div>' : '<div class="text-xs text-yellow-600 mt-2">⚠ Демо режим - ограниченные ответы</div>'}
            `;
            document.getElementById('moduleHeader').innerHTML = headerHtml;

            const questionsHtml = module.popularQuestions.map(question => 
                `<button class="question-btn w-full text-left p-3 bg-blue-50 rounded-lg text-blue-700 text-sm hover:bg-blue-100 transition-colors">${question}</button>`
            ).join('');
            document.getElementById('questionsList').innerHTML = questionsHtml;

            document.querySelectorAll('.question-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.getElementById('messageInput').value = this.textContent;
                    document.getElementById('messageInput').focus();
                });
            });

            document.getElementById('expertName').textContent = module.expertName;
            displayChatHistory(moduleId);

            const hasMessages = chatMessages[moduleId] && chatMessages[moduleId].length > 0;
            document.getElementById('popularQuestions').style.display = hasMessages ? 'none' : 'block';
        }

        function showHomePage() {
            // Очищаем память текущего диалога И визуальную историю при возврате на главную
            if (currentModule) {
                conversationHistory[currentModule] = [];
                chatMessages[currentModule] = [];
                
                // Очищаем визуальный чат в интерфейсе
                document.getElementById('chatMessages').innerHTML = '';
            }
            
            document.getElementById('homePage').style.display = 'block';
            document.getElementById('modulePage').style.display = 'none';
            currentModule = null;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if ((!message && !attachedFile) || isLoading) return;

            input.value = '';
            
            // Добавляем сообщение пользователя с информацией о файле
            let userMessage = message;
            if (attachedFile) {
                userMessage += attachedFile ? `\n\n📎 Прикреплен файл: ${attachedFile.name}` : '';
            }
            
            addUserMessage(userMessage);
            document.getElementById('popularQuestions').style.display = 'none';
            showLoading();

            let response;
            if (geminiApiKey) {
                response = await getGeminiResponse(message, attachedFile);
            } else {
                response = getDemoResponse(message);
            }

            hideLoading();
            addAIMessage(response);
            
            // Очищаем прикрепленный файл после отправки
            if (attachedFile) {
                attachedFile = null;
                document.getElementById('filePreview').style.display = 'none';
                document.getElementById('fileInput').value = '';
            }
        }

        // ГЛАВНОЕ ОТЛИЧИЕ - используем Google Gemini API с поддержкой файлов и памятью диалога
        async function getGeminiResponse(userMessage, file = null) {
            try {
                // Добавляем текущее сообщение в историю диалога
                conversationHistory[currentModule].push({
                    role: 'user',
                    message: userMessage,
                    timestamp: Date.now()
                });

                const systemPrompt = expertPrompts[currentModule];
                
                // Формируем контекст диалога для сохранения памяти
                let conversationContext = '';
                if (conversationHistory[currentModule].length > 1) {
                    const recentHistory = conversationHistory[currentModule].slice(-6); // Берем последние 6 сообщений
                    conversationContext = '\n\nКОНТЕКСТ НАШЕГО ДИАЛОГА:\n';
                    recentHistory.slice(0, -1).forEach((msg, index) => {
                        if (index % 2 === 0) {
                            conversationContext += `Пользователь: ${msg.message}\n`;
                        } else {
                            conversationContext += `Я отвечал: ${msg.message.substring(0, 150)}...\n`;
                        }
                    });
                }
                
                let fullPrompt = `${systemPrompt}${conversationContext}\n\nТекущий вопрос пользователя: ${userMessage}`;
                
                const parts = [{ text: fullPrompt }];
                
                // Если есть файл, добавляем его в запрос
                if (file && currentModule === 'web-design') {
                    if (file.type.startsWith('image/')) {
                        const base64Data = await fileToBase64(file);
                        parts.push({
                            inline_data: {
                                mime_type: file.type,
                                data: base64Data
                            }
                        });
                        parts[0].text += `\n\nПроанализируйте прикрепленное изображение подробно.`;
                    } else {
                        parts[0].text += `\n\nПользователь прикрепил файл "${file.name}" (${file.type}). К сожалению, я могу анализировать только изображения. Для анализа других типов файлов предложите пользователю описать содержимое или конвертировать в изображение.`;
                    }
                }
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content || !data.candidates[0].content.parts) {
                    throw new Error('Invalid response format from Gemini API');
                }

                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // Добавляем ответ ИИ в историю диалога
                conversationHistory[currentModule].push({
                    role: 'assistant',
                    message: aiResponse,
                    timestamp: Date.now()
                });

                return aiResponse;
            } catch (error) {
                console.error('Gemini API error:', error);
                return `Извините, произошла ошибка при обращении к Google Gemini. Попробуйте позже или проверьте настройки API ключа.\n\nОшибка: ${error.message}`;
            }
        }

        // Демо ответы остаются теми же
        function getDemoResponse(message) {
            const demoResponses = {
                'strategy': [
                    '🎯 ДЕМО ОТВЕТ бизнес-стратега 2025:\n\nДля стратегии в эпоху ИИ использую:\n\n1. AI-First Business Model анализ\n2. Digital Transformation Roadmap\n3. Data-Driven Decision Framework\n4. Agile Strategy с быстрыми итерациями\n\nКейс 2024: Внедрил ИИ-автоматизацию в e-commerce, прибыль выросла на 340%\n\n💡 Подключите Gemini для стратегии с учетом ИИ-трендов 2025.',
                    '📋 ДЕМО ОТВЕТ по структурированию проекта:\n\nМоя методология запуска:\n\n1. Discovery & Research (2-4 недели)\n2. Strategy & Planning (1-2 недели)\n3. Team Assembly (1 неделя)\n4. MVP Development (4-8 недель)\n5. Testing & Iteration (2-4 недели)\n6. Launch & Scale (ongoing)\n\nИнструменты: Miro, Notion, Figma, Slack\n\n💡 Могу создать project charter и детальный план, если опишете проект и ресурсы.',
                    '🔍 ДЕМО ОТВЕТ по анализу рынка:\n\nКомплексный анализ включает:\n\n• Market Sizing (TAM, SAM, SOM)\n• Competitive Landscape Mapping\n• Customer Journey Analysis\n• Value Proposition Canvas\n• Blue Ocean Strategy Framework\n\nКейс: Нашел нишу для fintech, которую пропустили 15 конкурентов\n\n💡 Могу провести стратегический анализ, если предоставите данные о рынке и продукте.'
                ],
                'marketing-basics': [
                    '🎯 ДЕМО ОТВЕТ от практичного маркетолога:\n\nДля определения ЦА делаю так:\n\n1. Выгружаю данные из CRM за 3 месяца\n2. Сегментирую по RFM (покупательская способность)\n3. Провожу 5-7 глубинных интервью\n4. Создаю 2-3 персоны с болями\n\nКейс: У клиента-фитнес тренера нашли 3 сегмента вместо 1. Конверсия выросла с 2% до 8%.\n\n💡 Могу углубиться, если расскажете о вашем бизнесе и текущих клиентах.',
                    '📊 ДЕМО ОТВЕТ:\n\nИз практики отслеживаю:\n\n• CAC по каналам (у меня Google Ads 850₽, email 50₽)\n• LTV/CAC ratio (минимум 3:1, у лучших клиентов 8:1)\n• Время окупаемости (стандарт 6 мес, достигаем 3 мес)\n• Конверсия воронки по этапам\n\nКейс: Оптимизировал воронку SaaS, LTV вырос с 12к до 28к рублей.\n\n💡 Могу дать точные бенчмарки, если укажете вашу нишу и средний чек.',
                    '⚡ ДЕМО ОТВЕТ:\n\nВоронка, которая работает:\n\n1. Лид-магнит (конверсия 15-25%)\n2. Welcome-серия 7 писем (открываемость 45%)\n3. Вебинар или демо (конверсия в продажу 8-12%)\n4. Персональное предложение (закрытие 25-40%)\n\nКейс: Для B2B консалтинга настроил воронку. Из 1000 лидов получили 47 продаж, средний чек 85к.\n\n💡 Могу адаптировать под ваш продукт, если расскажете что продаете и какой средний чек.'
                ],
                'social-media': [
                    '📱 ДЕМО ОТВЕТ SMM-эксперта 2025:\n\nНовый алгоритм Instagram 2025:\n\n• Приоритет вертикального контента\n• ИИ-персонализация ленты\n• Threads cross-posting бонус\n• Интерактивные Stories с ИИ\n\n🔥 В полной версии дам актуальную стратегию роста.',
                    '🛍️ ДЕМО ОТВЕТ:\n\nTikTok Shop тренды 2025:\n\n• Живые продажи (Live Shopping)\n• Короткие обзоры товаров\n• Интеграция с местными брендами\n• Сотрудничество с микро-инфлюенсерами\n\n⚡ Подключите Gemini для стратегии монетизации.'
                ],
                'context-targeting': [
                    '📱 ДЕМО ОТВЕТ эксперта по рекламе 2025:\n\nРеклама в Telegram через Яндекс.Директ:\n\n• Новый тип кампаний "Продвижение в Telegram"\n• Таргетинг по интересам и каналам\n• CPM от 50₽, CPC от 8₽\n• Нативные форматы в ленте\n\n💡 В полной версии дам пошаговую настройку кампании.',
                    '🎯 ДЕМО ОТВЕТ 2025:\n\nAdvantage+ кампании Meta:\n\n• ИИ автоматически находит аудитории\n• Снижение CPA на 20-40%\n• Новые креативные форматы\n• Интеграция с Threads\n\n🚀 Подключите Gemini для настройки под ваш бизнес.'
                ],
                'web-design': [
                    '📸 ДЕМО ОТВЕТ аналитика:\n\nАнализ изображений:\n\n• Детальное описание визуального контента\n• Анализ композиции и цветовой палитры\n• Оценка качества и стиля\n• Выявление брендинговых элементов\n\n📋 Загрузите изображение для полного анализа с Gemini.',
                    '📄 ДЕМО ОТВЕТ:\n\nАнализ документов:\n\n• PDF: извлечение ключевой информации\n• Word/Excel: структурирование данных\n• Технические спецификации\n• Финансовые отчеты\n\n🌐 Для сайтов: UX-аудит, SEO-анализ, контентная стратегия\n\n💡 Укажите ссылку на сайт или загрузите документ для детального анализа с Gemini.'
                ],
                'ai-content': [
                    '🤖 ДЕМО ОТВЕТ ИИ-эксперта 2025:\n\nЛучшие ИИ для работы сейчас:\n\n• ChatGPT o1 - сложный анализ и рассуждения\n• Claude 3.5 Sonnet - код и документы\n• Gemini 2.0 - мультимодальные задачи\n• Cursor - разработка приложений\n\n🧠 В полной версии покажу как комбинировать ИИ для максимальной эффективности.',
                    '🎬 ДЕМО ОТВЕТ 2025:\n\nSora Turbo уже доступен:\n\n• До 60 секунд качественного видео\n• Консистентные персонажи\n• Киноматографические эффекты\n• Интеграция с другими ИИ\n\n🚀 Подключите Gemini для примеров и инструкций по Sora.'
                ],
                'prompting': [
                    '🧠 ДЕМО ОТВЕТ промпт-инженера 2025:\n\nПромпт для ChatGPT o1:\n\n"<reasoning>\nПодумай пошагово над этой задачей:\n- Анализ контекста\n- Возможные решения  \n- Выбор оптимального\n- Проверка логики\n</reasoning>\n\n[твоя задача]"\n\n💡 В полной версии дам техники для всех новых ИИ-моделей.',
                    '⚡ ДЕМО ОТВЕТ 2025:\n\nMeta-Prompt техника:\n\n"Создай промпт, который будет создавать промпты для [цель]. Учти:\n- Контекст применения\n- Целевую ИИ-модель\n- Ожидаемый формат ответа\n- Критерии качества"\n\n🎯 Подключите Gemini для продвинутых техник промптинга.'
                ]
            };

            const responses = demoResponses[currentModule] || demoResponses['marketing-basics'];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        function addUserMessage(message) {
            if (!chatMessages[currentModule]) {
                chatMessages[currentModule] = [];
            }

            const messageObj = {
                id: Date.now(),
                type: 'user',
                content: message,
                timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            };

            chatMessages[currentModule].push(messageObj);
            displayMessage(messageObj);
        }

        function addAIMessage(message) {
            const messageObj = {
                id: Date.now() + 1,
                type: 'ai',
                content: message,
                timestamp: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            };

            chatMessages[currentModule].push(messageObj);
            displayMessage(messageObj);
        }

        function displayMessage(message) {
            const chatContainer = document.getElementById('chatMessages');
            
            if (message.type === 'user') {
                const userHtml = `
                    <div class="flex justify-end">
                        <div class="bg-blue-500 text-white rounded-lg p-3 max-w-xs">
                            <p class="text-sm">${message.content}</p>
                            <p class="text-xs opacity-75 mt-1">${message.timestamp}</p>
                        </div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', userHtml);
            } else {
                const module = modules[currentModule];
                const aiHtml = `
                    <div class="flex justify-start mt-2">
                        <div class="bg-white border rounded-lg p-3 max-w-sm">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="${module.color} w-4 h-4 rounded-full flex items-center justify-center">
                                    <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 8 8">
                                        <circle cx="4" cy="4" r="3"/>
                                    </svg>
                                </div>
                                <span class="text-xs font-medium text-gray-600">${module.expertName}</span>
                            </div>
                            <div class="text-sm text-gray-800 whitespace-pre-wrap">${message.content}</div>
                            <p class="text-xs text-gray-400 mt-2">${message.timestamp}</p>
                        </div>
                    </div>
                `;
                chatContainer.insertAdjacentHTML('beforeend', aiHtml);
            }
            
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function displayChatHistory(moduleId) {
            const chatContainer = document.getElementById('chatMessages');
            chatContainer.innerHTML = '';
            
            if (chatMessages[moduleId]) {
                chatMessages[moduleId].forEach(message => {
                    displayMessage(message);
                });
            }
        }

        function showLoading() {
            isLoading = true;
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('sendButton').disabled = true;
            document.getElementById('messageInput').disabled = true;
        }

        function hideLoading() {
            isLoading = false;
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').disabled = false;
        }

        function showFilePreview(file) {
            const fileName = file.name;
            const fileSize = formatFileSize(file.size);
            
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileSize').textContent = fileSize;
            document.getElementById('filePreview').style.display = 'block';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Функция для конвертации файла в base64 для отправки в Gemini
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>
</html>